<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom"

     xmlns:yandex="http://news.yandex.ru"
     xmlns:turbo="http://turbo.yandex.ru"

     version="2.0">
    <channel>
        <title>Блог TinyOps</title>
        <link>https:&#x2F;&#x2F;b.tinyops.ru</link>
        <description>О технологиях, подходах и решении проблем простым языком</description>
        <generator>Zola</generator>
        <language>ru</language>
        <atom:link href="https:&#x2F;&#x2F;b.tinyops.ru/rss.xml" rel="self" type="application/rss+xml"/>
        <lastBuildDate>2020-10-12</lastBuildDate>

        
        <turbo:analytics type="Yandex"
                         id="56992924"
                         params="{}"></turbo:analytics>
        

        
        <item
            
                turbo="true"
            
            >
            <title>Как настроить chroot для sftp в CentOS 7</title>
            <pubDate>2020-10-12</pubDate>
            <link>https:&#x2F;&#x2F;b.tinyops.ru/sftp-chroot-centos7</link>
            <guid>https:&#x2F;&#x2F;b.tinyops.ru/sftp-chroot-centos7</guid>
            <description>Ограничить доступ через SFTP домашним каталогом пользователя</description>
            
                <turbo:source></turbo:source>
                <turbo:topic></turbo:topic>
                <metrics>
                    <yandex schema_identifier="56992924">
                        <breadcrumblist>
                            <breadcrumb url="https:&#x2F;&#x2F;b.tinyops.ru/" text="Главная"/>

                            
                            <breadcrumb url="https:&#x2F;&#x2F;b.tinyops.ru/categories/centos" text="Категория centos"/>
                            
                            <breadcrumb url="https:&#x2F;&#x2F;b.tinyops.ru/categories/linux" text="Категория linux"/>
                            
                            <breadcrumb url="https:&#x2F;&#x2F;b.tinyops.ru/categories/security" text="Категория security"/>
                            

                            
                                <breadcrumb url="https:&#x2F;&#x2F;b.tinyops.ru/tags/linux" text="Тэг linux"/>
                            
                                <breadcrumb url="https:&#x2F;&#x2F;b.tinyops.ru/tags/security" text="Тэг security"/>
                            
                                <breadcrumb url="https:&#x2F;&#x2F;b.tinyops.ru/tags/chroot" text="Тэг chroot"/>
                            
                                <breadcrumb url="https:&#x2F;&#x2F;b.tinyops.ru/tags/sftp" text="Тэг sftp"/>
                            

                            <breadcrumb url="https:&#x2F;&#x2F;b.tinyops.ru/sftp-chroot-centos7" text="Как настроить chroot для sftp в CentOS 7"/>
                        </breadcrumblist>
                    </yandex>
                </metrics>
                <yandex:related></yandex:related>
                <turbo:content>
                    &lt;p&gt;В современных дистрибутивах Linux очень легко дать доступ пользователю через SFTP. 
Для этого достаточно создать пользователя и запустить службу &lt;code&gt;sshd&lt;&#x2F;code&gt;. По умолчанию пользователь сможет перемещаться 
по всем каталогам операционной системы к которым имеет доступ на чтение. Это очень плохо с точки зрения безопасности.&lt;&#x2F;p&gt;
&lt;p&gt;К счастью, &lt;code&gt;sshd&lt;&#x2F;code&gt; позволяет указать корневой каталог для пользователя (механизм chroot).&lt;&#x2F;p&gt;
&lt;p&gt;Дальнейшая настройка будет актуальна для CentOS 7 и OpenSSH 7.4, но скорей всего сработает и для других версий.&lt;&#x2F;p&gt;
&lt;p&gt;В качестве корневого каталога будет путь &lt;code&gt;&#x2F;sftp&#x2F;bob&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;nastraivaem-sluzhbu-sshd&quot;&gt;Настраиваем службу sshd&lt;&#x2F;h3&gt;
&lt;p&gt;Добавляем в конец конфигурационного файла sshd &lt;code&gt;&#x2F;etc&#x2F;ssh&#x2F;sshd_config&lt;&#x2F;code&gt; следующий текст (комментарии можно не добавлять):&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;&quot;&gt;
&lt;span style=&quot;color:#c0c5ce;&quot;&gt;Match User bob&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
 # Запрещаем &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
 X11Forwarding no&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
 # Запрещаем проксирование tcp-трафика&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
 AllowTcpForwarding no&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
 # Мы будем использовать только подсистему sftp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
 ForceCommand internal-sftp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
 # Корневой каталог для пользователя&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
 ChrootDirectory &#x2F;sftp&#x2F;bob&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Проверяем что конфигурация без ошибок:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;&quot;&gt;
&lt;span style=&quot;color:#c0c5ce;&quot;&gt;sshd -t&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Если ошибок нет, то ответа от команды не последует. Затем рестартуем службу:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;&quot;&gt;
&lt;span style=&quot;color:#c0c5ce;&quot;&gt;systemctl restart sshd&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;pre&gt;&lt;h3 id=&quot;ustanavlivaem-korrektnye-prava&quot;&gt;Устанавливаем корректные права&lt;&#x2F;h3&gt;
&lt;p&gt;У механизма chroot есть требование для владельцев по пути к корневому каталогу:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;ChrootDirectory&lt;&#x2F;strong&gt;&lt;br &#x2F;&gt;
Specifies the pathname of a directory to chroot(2) to after authentication. All components of the pathname must 
be root-owned directories that are not writable by any other user or group. After the chroot, sshd(8) 
changes the working directory to the user&#x27;s home directory.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Владельцем на пути до корневого каталога (включительно) должен быть &lt;code&gt;root&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Поэтому делаем так:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;&quot;&gt;
&lt;span style=&quot;color:#c0c5ce;&quot;&gt;chown -R root: &#x2F;vfs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Если с правами что-то не так то в файле &lt;code&gt;&#x2F;var&#x2F;log&#x2F;secure&lt;&#x2F;code&gt; будет ошибка &lt;code&gt;fatal: bad ownership or modes for chroot directory&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;testiruem&quot;&gt;Тестируем&lt;&#x2F;h3&gt;
&lt;pre style=&quot;background-color:#2b303b;&quot;&gt;
&lt;span style=&quot;color:#c0c5ce;&quot;&gt;$ sftp bob@your-server&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
Connected to your-server.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
sftp&amp;gt; ls&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
lost+found  test&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
sftp&amp;gt; pwd&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
Remote working directory: &#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c0c5ce;&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Всё работает.&lt;&#x2F;p&gt;

                </turbo:content>
            
        </item>
        
        
    </channel>
</rss>
