+++
title = "Как управлять dotfiles"
description = "Что такое dotfiles и как правильно организовать работу с ними."
date = 2021-04-03
updated = 2021-07-14

[taxonomies]
tags = ["linux", "dotfiles"]
categories = ["linux"]
+++

Dotfiles — это текстовые конфигурационные файлы в операционных системах Unix и Linux. 
Например, `.bash_profile`, `.vimrc` и т.д. Они называются именно так потому что обычно имя файла начинается со знака точки.
Тем не менее часть файлов конфигурации не начинаются со знака точки, но в то же время относятся к `dotfiles`.

### Проблемы с dotfiles

Что может быть проще текстовых файлов?
Чем больше таких файлов, тем сложней ими управлять, требуется определённый подход.

Самые популярные проблемы:

- У меня несколько компьютеров. Как мне перемещать файлы между ними? Как синхронизировать изменения?
- Конфигурация Vim (файл `.vimrc`) может быть максимально подходить для одного компьютера и быть избыточной для всех остальных
- В ваших `dotfiles` может быть приватная информация, которую нельзя публиковать в git

## Организационный подход
Если вы разработчик, то работа с `dotfiles`, хранение и усовершенствование, для вас самый долгий проект из всех над которыми вы работали. 
В связи с этим имеет смысл организовать свой проект дисциплинированно, для удобства сопровождения и расширяемости.

Многие пользователи хранят `dotfiles` в git, потому что это очень удобно.
Можно [найти более 150 тысяч примеров на Github](https://github.com/search?q=dotfiles).

Преимущества такого подхода:

- У вас будет резервная копия, которая убережёт файлы от потери и повреждений:
    - Вышел из строя жёсткий диск
    - Случайное удаление
- История изменений:
    - Возможность свободно экспериментировать с настройками и легко откатить изменения
    - Возможность посмотреть настройки за все время существования ваших dotfiles, даже через несколько лет спустя.

Для `dotfiles` лучше выделить отдельный каталог — `.dotfiles` в корне домашней директории. 
Хранить в системе контроля версий домашний каталог не рекомендуется, т. к. усложнит поддержку `dotfiles`, 
а также команда типа `git clean` может удалить все файлы, и даже те, которые не входят в состав репозитория.

В качестве системы контроля версий подойдёт любая: git, mercurial, svn и т. д. Я использую git.

Несмотря на удобство систем контроля версий, не рекомендуется копировать один в один чужие `dotfiles`, 
без понимания того, для чего сделаны те или иные настройки. 
`Dotfiles` должны быть написаны под вас, чужие — могут служить источником знаний или вдохновения.

## С чего начать

Создадим каталог и репозиторий:

```bash
mkdir ~/.dotfiles && cd ~/.dotfiles
git init
```

Создадим на Github отдельный репозиторий `dotfiles`. Копируем ссылку и добавляем к локальному:

```bash
git remote add origin git@github.com:your-user/dotfiles.git
```

Для примера добавим конфигурацию vim в наши dotfiles.

```bash
mkdir -p ~/.dotfiles/vim/plugins
cp ~/.vimrc ~/.dotfiles/vim
```

Добавим в git и запушим изменения на GitHub:

```
git checkout main
git add *
git commit -a -m "[+] add .vimrc"
git push
```

Здесь стоит отметить, что я использую ветку `main` вместо `master`, т. к. так заведено на GitHub.

## Установка dotfiles
Продолжаем пример с `.vimrc`-файлом. Удалим текущий и создадим ссылку на тот что хранится в dotfiles:

```bash
rm -f ~/.vimrc
ln -s ~/.dotfiles/vim/.vimrc ~/.vimrc
```

Когда ваш репозиторий будет наполнен файлами, имеет смысл написать скрипт, который будет создавать правильные ссылки в домашнем каталоге.

## Зависимости и плагины
Помимо файлов конфигурации для приложений в `dotfiles` можно хранить удобные скрипты и плагины. Нет смысла добавлять плагины в виде файлов в наш репозиторий, но имеет смысл добавить их в виде суб-модулей.

Я использую плагин [NERDTree](https://github.com/preservim/nerdtree) для vim. Добавим репозиторий проекта в виде суб-модуля:

```bash
git submodule add https://github.com/preservim/nerdtree vim/plugins/nerdtree
```

## Установка зависимостей и плагинов

Установка и обновление до последних версий:
```bash
git submodule update --init --recursive
git submodule update --init --remote
```

Создаём ссылку (symlink) на каталог с плагинами:

```bash
ln -s ~/.dotfiles/vim/plugins ~/.vim/plugged
```

Каталог `~/vim/plugged` может отличаться от вашего, я использую рекомендованный от [vim-plug](https://github.com/junegunn/vim-plug).

## Специфичные локальные настройки
При использовании `dotfiles` на множестве машин большая часть конфигурации будет одна и та же. Но возможны небольшие различия.

Например, на одной машине вам нужна поддержка Rust для Vim, а на всех остальных — нет. Также могут отличаться набор закладок для `nnn`.

Для хранения различий можно использовать разные ветви в git, но это очень быстро превратится в хаос.

Один из подходов — иметь главный репозиторий для dotfiles, с файлами, которые подходят для всех машин, а также отдельный репозиторий dotfiles_local для персональных настроек под каждую машину.

В репозитории `dotfiles_local` каждая ветвь именуется именем машины. Например, `home-pc`, `work-pc`.

### Как подгружать специфичные настройки

Для bash добавляем в `~/.bashrc`:
```bash
if [ -f ~/.bashrc_local ]; then
    source ~/.bashrc_local
fi
```

Для git добавляем в `~/.gitconfig`:
```
[include]
	path = ~/.gitconfig_local
```

Для Vim, добавляем в файл `.vimrc`:
```vim
let $LOCALFILE=expand("~/.vimrc_local")
if filereadable($LOCALFILE)
    source $LOCALFILE
endif
```

## Специальные скрипты
Если у вас есть какие-то скрипты, которые вы используете в своей работе, их тоже можно добавить в dotfiles. Например, в каталог `.dotfiles/bin`.

Затем в `.bashrc` добавляем их в переменную `PATH`:
```bash
export PATH=~/.dotfiles/bin:${PATH}
```
